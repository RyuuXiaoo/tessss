const f=new Intl.NumberFormat('id-ID');const rp=n=>`Rp${f.format(n)}`;const st={get(){try{return JSON.parse(localStorage.getItem('rx_products')||'null')}catch{return null}},set(v){localStorage.setItem('rx_products',JSON.stringify(v))}};const bal={g(){return Number(localStorage.getItem('rx_balance')||'0')},s(n){localStorage.setItem('rx_balance',String(n))},a(n){this.s(this.g()+n)},m(n){this.s(Math.max(0,this.g()-n))}};const seed={categories:['Streaming','Game','Tools','Voucher'],products:[{id:'netflix',name:'Netflix 1 Bulan',desc:'Akun Netflix premium',snk:'Garansi 7 hari',price:30000,profit:5000,terjual:0,category:'Streaming',stok:['acc1@mail.com|pass1|Standard|-|2FA1|32000','acc2@mail.com|pass2|Premium|-|2FA2|32000']},{id:'spotify',name:'Spotify Premium',desc:'Premium Individual',snk:'Garansi 7 hari',price:20000,profit:4000,terjual:0,category:'Streaming',stok:['spo1@mail.com|pass1|ID|-|2FA|20000','spo2@mail.com|pass2|ID|-|2FA|20000']},{id:'disney',name:'Disney+ Hotstar',desc:'Akun Disney+ 1 Bulan',snk:'Garansi 7 hari',price:28000,profit:4000,terjual:0,category:'Streaming',stok:['d1@mail.com|p1|ID|-|-|28000','d2@mail.com|p2|ID|-|-|28000']},{id:'mlbb',name:'Diamond MLBB 86',desc:'Top-up otomatis',snk:'Proses instan',price:23000,profit:3000,terjual:0,category:'Game',stok:['uid1|zone1|profil|-|-|23000','uid2|zone2|profil|-|-|23000']},{id:'steam',name:'Voucher Steam 45K',desc:'Kode voucher region ID',snk:'Garansi 24 jam',price:45000,profit:5000,terjual:0,category:'Voucher',stok:['CODE-STEAM-1|XXXX|-|-|-|45000','CODE-STEAM-2|XXXX|-|-|-|45000']}]};let data=st.get()||seed;document.getElementById('year').textContent=new Date().getFullYear();document.getElementById('feePct').textContent=String(Number(window.AppConfig?.pajak??3));document.getElementById('userBalance').textContent=rp(bal.g());const cat=document.getElementById('category');(function(){const c=data.categories||[];cat.innerHTML='<option value="">Semua Kategori</option>'+c.map(x=>`<option>${x}</option>`).join('')})();const grid=document.getElementById('productGrid');function pc(){return data.products.filter(p=>p.stok.length>0).length}function render(){const q=(document.getElementById('search').value||'').toLowerCase();const c=cat.value;const list=data.products.filter(p=>(!q||p.name.toLowerCase().includes(q)||p.id.toLowerCase().includes(q))&&(!c||p.category===c));document.getElementById('prodCount').textContent=String(pc());grid.innerHTML=list.map(p=>`<div class="card"><div class="img"></div><div class="body"><h3 class="title">${p.name}</h3><div class="desc">${p.desc||'-'}</div><div class="meta"><span class="badge">Kategori: ${p.category||'-'}</span><span class="badge">Stok: ${p.stok.length}</span><span class="badge">Terjual: ${p.terjual||0}</span></div><div class="price">${rp(Number(p.price))}</div><div class="buy"><input type="number" min="1" value="1" id="qty_${p.id}"/><button class="btn" ${p.stok.length===0?'disabled':''} onclick="startBuy('${p.id}')">Beli</button></div></div></div>`).join('')}render();document.getElementById('search').addEventListener('input',render);cat.addEventListener('change',render);document.getElementById('reset').addEventListener('click',()=>{document.getElementById('search').value='';cat.value='';render()});const buyDialog=document.getElementById('buyDialog');const deliverDialog=document.getElementById('deliverDialog');const checkoutBody=document.getElementById('checkoutBody');const deliverBody=document.getElementById('deliverBody');window.startBuy=id=>{const p=data.products.find(x=>x.id===id);if(!p)return alert('Produk tidak ditemukan');const qty=Number(document.getElementById('qty_'+id).value||'1');if(!qty||qty<=0)return alert('Jumlah tidak valid');if(p.stok.length<qty)return alert('Stok tidak cukup! Tersedia: '+p.stok.length);const s=(p.stok[0]||'').split('|');const unit=(s.length>=6&&!isNaN(Number(s[5])))?Number(s[5]):Number(p.price);const base=unit*qty;const fee=Math.ceil(base*((Number(window.AppConfig?.pajak??3))/100));const total=base+fee;const balv=bal.g();const need=balv<total?(total-balv):0;checkoutBody.innerHTML=`<table style="width:100%"><tr><td>Produk</td><td style="text-align:right"><strong>${p.name}</strong></td></tr><tr><td>Jumlah</td><td style="text-align:right"><strong>${qty}</strong></td></tr><tr><td>Harga Dasar</td><td style="text-align:right">${rp(base)}</td></tr><tr><td>Biaya Admin (${Number(window.AppConfig?.pajak??3)}%)</td><td style="text-align:right">${rp(fee)}</td></tr><tr><td><strong>Total</strong></td><td style="text-align:right"><strong>${rp(total)}</strong></td></tr><tr><td>Saldo Anda</td><td style="text-align:right">${rp(balv)}</td></tr>${need?`<tr><td>Kekurangan</td><td style="text-align:right"><span class="mono">${rp(need)}</span></td></tr>`:''}</table><div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px"><button class="btn btn-secondary" onclick="buyDialog.close()">Tutup</button><button id="btnPay" class="btn">${need?'Bayar Kekurangan':'Bayar & Proses'}</button></div><div id="payArea"></div>`;buyDialog.showModal();document.getElementById('btnPay').onclick=()=>pay(p,qty,base,fee,total,need)};async function pay(prod,qty,base,fee,total,need){const area=document.getElementById('payArea');if(need<=0){bal.m(total);done(prod,qty,base,fee,total);buyDialog.close();return}const {apikey,username,tokenorkut}=window.AppConfig.api;const url=`https://apii.ryuuxiao.biz.id/orderkuota/createpayment?apikey=${encodeURIComponent(apikey)}&username=${encodeURIComponent(username)}&token=${encodeURIComponent(tokenorkut)}&amount=${encodeURIComponent(need)}`;area.innerHTML='<div class="desc">Membuat QRIS...</div>';try{const r=await fetch(url);const j=await r.json();if(!j?.status)throw new Error('Gagal membuat QRIS');const img=j.result?.imageqris?.url;const deadline=Date.now()+(Number(window.AppConfig?.paymentWindowMinutes||30)*60*1000);area.innerHTML=`<div style="display:flex;gap:14px;align-items:flex-start;margin-top:8px"><div class="qr"><img src="${img}" alt="QRIS" style="max-width:240px;width:100%;height:auto"/></div><div style="flex:1"><div><strong>Scan untuk bayar ${rp(need)}</strong></div><div id="count" class="desc"></div><div style="margin-top:8px"><button class="btn btn-secondary" id="btnCancel">Batalkan</button></div></div></div>`;const el=document.getElementById('count');const t=setInterval(()=>{const left=deadline-Date.now();if(left<=0){clearInterval(t);area.innerHTML='<div class="desc">Waktu pembayaran habis.</div>'}const m=Math.floor(left/60000),s=Math.floor((left%60000)/1000);if(left>0)el.textContent=`Bayar sebelum ${new Date(deadline).toLocaleTimeString('id-ID',{hour12:false})} WIB (${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')})`},1000);let stop=false;const poll=setInterval(async()=>{if(stop){clearInterval(poll);return}if(Date.now()>=deadline){clearInterval(poll);return}try{const mu=await fetch(`https://apii.ryuuxiao.biz.id/orderkuota/mutasiqr?apikey=${encodeURIComponent(apikey)}&username=${encodeURIComponent(username)}&token=${encodeURIComponent(tokenorkut)}`);const jj=await mu.json();const list=jj?.result||[];const ok=list.find(x=>x.status==='IN'&&Number(String(x.kredit||'0').replace(/\./g,''))===need);if(ok){clearInterval(poll);clearInterval(t);bal.a(need);bal.m(total);buyDialog.close();done(prod,qty,base,fee,total)}}catch(e){}},10000);document.getElementById('btnCancel').onclick=()=>{stop=true;clearInterval(t);clearInterval(poll);area.innerHTML='<div class="desc">‚ùå Transaksi QRIS dibatalkan.</div>'}}catch(e){area.innerHTML=`<div class="desc">Error: ${e.message}</div>`}}function done(prod,qty,base,fee,total){const items=[];for(let i=0;i<qty;i++){const line=prod.stok.shift();const [email,pass,profil='-',pin='-',fa='-']=(line||'').split('|');items.push({email,pass,profil,pin,fa})}prod.terjual+=qty;st.set(data);render();document.getElementById('userBalance').textContent=rp(bal.g());const ref=(l=>{const a='ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';let o='';for(let i=0;i<l;i++)o+=a[Math.floor(Math.random()*a.length)];return o})(8).toUpperCase();const tanggal=new Date().toLocaleDateString('id-ID',{day:'2-digit',month:'long',year:'numeric'});const jam=new Date().toLocaleTimeString('id-ID',{hour12:false});const head=['‚îÄ‚îÄ‚îÄ„Äå ACCOUNT DETAIL „Äç‚îÄ‚îÄ‚îÄ','Silakan simpan detail berikut.','', '‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ„Äå TRANSAKSI DETAIL „Äç‚îÄ‚îÄ‚îÄ‚îÄ',`‚îä„Éª üßæ Reff ID: ${ref}`,`‚îä„Éª üì¶ Produk: ${prod.name}`,`‚îä„Éª üè∑Ô∏è Harga Dasar: ${rp(base)}`,`‚îä„Éª üìà Biaya Admin (${Number(window.AppConfig?.pajak??3)}%): ${rp(fee)}`,`‚îä„Éª üõçÔ∏è Jumlah: ${qty}`,`‚îä„Éª üí∞ Total Bayar: ${rp(total)}`,`‚îä„Éª üìÖ Tanggal: ${tanggal}`,`‚îä„Éª ‚è∞ Jam: ${jam} WIB`,'‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ','','‚îÄ‚îÄ‚îÄ„Äå SNK PRODUK „Äç‚îÄ‚îÄ‚îÄ', (prod.snk||'-'), '', '‚îÄ‚îÄ‚îÄ„Äå DATA AKUN „Äç‚îÄ‚îÄ‚îÄ'].join('\n');const akun=items.map(x=>`‚Ä¢ Email: ${x.email}\n‚Ä¢ Password: ${x.pass}\n‚Ä¢ Profil: ${x.profil}\n‚Ä¢ Pin: ${x.pin}\n‚Ä¢ 2FA: ${x.fa}\n`).join('\n');const txt=head+'\n'+akun;const blob=new Blob([txt],{type:'text/plain'});const url=URL.createObjectURL(blob);deliverBody.innerHTML=`<div class="desc">Pembelian berhasil. Unduh file TXT berikut:</div><div style="margin:10px 0"><a class="btn" href="${url}" download="TRX-${ref}.txt">Unduh TRX-${ref}.txt</a></div><pre class="mono" style="white-space:pre-wrap;background:#0b1533;border:1px solid #1f2a44;padding:12px;border-radius:12px;max-height:260px;overflow:auto">${txt.replace(/</g,'&lt;')}</pre>`;deliverDialog.showModal()}