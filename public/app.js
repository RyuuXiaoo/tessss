
const fmt=new Intl.NumberFormat('id-ID');const toRp=n=>'Rp'+fmt.format(n);
const store={get(){try{return JSON.parse(localStorage.getItem('rx_products')||'null')}catch{return null}},set(v){localStorage.setItem('rx_products',JSON.stringify(v))}};
const balance={get(){return Number(localStorage.getItem('rx_balance')||'0')},set(n){localStorage.setItem('rx_balance',String(n))},add(n){this.set(this.get()+n)},min(n){this.set(Math.max(0,this.get()-n))}};
const seed={categories:['Streaming','Game','Tools','Voucher'],products:[
 {id:'netflix',name:'Netflix 1 Bulan',desc:'Akun Netflix premium',snk:'Garansi 7 hari',price:30000,profit:5000,terjual:0,category:'Streaming',stok:['acc1@mail.com|pass1|Standard|-|2FA1|32000','acc2@mail.com|pass2|Premium|-|2FA2|32000']},
 {id:'spotify',name:'Spotify Premium',desc:'Premium Individual',snk:'Garansi 7 hari',price:20000,profit:4000,terjual:0,category:'Streaming',stok:['spo1@mail.com|pass1|ID|-|2FA|20000','spo2@mail.com|pass2|ID|-|2FA|20000']},
 {id:'disney',name:'Disney+ Hotstar',desc:'Akun Disney+ 1 Bulan',snk:'Garansi 7 hari',price:28000,profit:4000,terjual:0,category:'Streaming',stok:['d1@mail.com|p1|ID|-|-|28000','d2@mail.com|p2|ID|-|-|28000']},
 {id:'mlbb',name:'Diamond MLBB 86',desc:'Top-up otomatis',snk:'Proses instan',price:23000,profit:3000,terjual:0,category:'Game',stok:['uid1|zone1|profil|-|-|23000','uid2|zone2|profil|-|-|23000']},
 {id:'steam',name:'Voucher Steam 45K',desc:'Kode voucher region ID',snk:'Garansi 24 jam',price:45000,profit:5000,terjual:0,category:'Voucher',stok:['CODE1|XXXX|-|-|-|45000','CODE2|XXXX|-|-|-|45000']}
]};
let data=store.get()||seed;
const fee=Number(window.AppConfig?.pajak??3);
document.getElementById('feePct').textContent=fee+'%';
document.getElementById('userBalance').textContent=toRp(balance.get());
const catSel=document.getElementById('category');function setCats(){catSel.innerHTML='<option value="">Semua Kategori</option>'+(data.categories||[]).map(c=>`<option>${c}</option>`).join('')}setCats();
const grid=document.getElementById('productGrid');
function prodCount(){return (data.products||[]).filter(p=>p.stok.length>0).length}
function card(p){return `<div class="card"><div class="row" style="justify-content:space-between"><strong>${p.name}</strong><span class="badge">${p.category||'-'}</span></div><div style="color:var(--muted);font-size:12px">${p.desc||'-'}</div><div class="row"><span class="badge">Stok: ${p.stok.length}</span><span class="badge">Terjual: ${p.terjual||0}</span></div><div style="font-weight:800;font-size:20px">${toRp(Number(p.price))}</div><div class="row"><input type="number" min="1" value="1" id="qty_${p.id}"><button class="btn" ${p.stok.length===0?'disabled':''} onclick="startBuy('${p.id}')">Beli</button></div></div>`}
function render(){const q=(document.getElementById('search').value||'').toLowerCase();const cat=catSel.value;const list=(data.products||[]).filter(p=>(!q||p.name.toLowerCase().includes(q)||p.id.toLowerCase().includes(q))&&(!cat||p.category===cat));document.getElementById('prodCount').textContent=String(prodCount());grid.innerHTML=list.map(card).join('')}render();
document.getElementById('search').addEventListener('input',render);catSel.addEventListener('change',render);document.getElementById('reset').addEventListener('click',()=>{document.getElementById('search').value='';catSel.value='';render()});
const buyDialog=document.getElementById('buyDialog'),deliverDialog=document.getElementById('deliverDialog'),checkoutBody=document.getElementById('checkoutBody'),deliverBody=document.getElementById('deliverBody');
window.startBuy=(id)=>{const p=data.products.find(x=>x.id===id);if(!p)return;const qty=Number(document.getElementById('qty_'+id).value||'1');if(!qty||qty<=0)return alert('Jumlah tidak valid');if(p.stok.length<qty)return alert('Stok tidak cukup! Tersedia: '+p.stok.length);const s=(p.stok[0]||'').split('|');const unit=(s.length>=6&&!isNaN(Number(s[5])))?Number(s[5]):Number(p.price);const base=unit*qty;const adm=Math.ceil(base*(fee/100));const total=base+adm;const bal=balance.get();const need=bal<total?(total-bal):0;checkoutBody.innerHTML=`<table style="width:100%"><tr><td>Produk</td><td style="text-align:right"><strong>${p.name}</strong></td></tr><tr><td>Jumlah</td><td style="text-align:right"><strong>${qty}</strong></td></tr><tr><td>Harga Dasar</td><td style="text-align:right">${toRp(base)}</td></tr><tr><td>Biaya Admin (${fee}%)</td><td style="text-align:right">${toRp(adm)}</td></tr><tr><td><strong>Total</strong></td><td style="text-align:right"><strong>${toRp(total)}</strong></td></tr><tr><td>Saldo Anda</td><td style="text-align:right">${toRp(bal)}</td></tr>${need?`<tr><td>Kekurangan</td><td style="text-align:right"><span class="badge">${toRp(need)}</span></td></tr>`:''}</table><div class="row" style="justify-content:flex-end"><button class="btn-ghost" onclick="buyDialog.close()">Tutup</button><button id="btnPay" class="btn">${need?'Bayar Kekurangan':'Bayar & Proses'}</button></div><div id="payArea"></div>`;buyDialog.showModal();document.getElementById('btnPay').onclick=()=>pay(p,qty,base,adm,total,need)};
async function pay(prod,qty,base,adm,total,need){const area=document.getElementById('payArea');if(need<=0){balance.min(total);return done(prod,qty,base,adm,total)}area.innerHTML=`<div class="badge">Simulasi QRIS ${toRp(need)} ‚Äî gunakan backend untuk transaksi real.</div><div class="row" style="justify-content:flex-end"><button id="btnCancel" class="btn-ghost">Batalkan</button><button id="btnSim" class="btn">Tandai Sudah Bayar</button></div>`;let stopped=false;document.getElementById('btnCancel').onclick=()=>{stopped=true;area.innerHTML='<div class="badge">‚ùå Transaksi QRIS dibatalkan.</div>'};document.getElementById('btnSim').onclick=()=>{if(stopped)return;balance.add(need);balance.min(total);done(prod,qty,base,adm,total)}};
function done(prod,qty,base,adm,total){buyDialog.close();const items=[];for(let i=0;i<qty;i++){const line=prod.stok.shift();const [email,pass,profil='-',pin='-',fa='-']=(line||'').split('|');items.push({email,pass,profil,pin,fa})}prod.terjual+=qty;store.set(data);render();document.getElementById('userBalance').textContent=toRp(balance.get());const ref=r(8).toUpperCase();const tanggal=new Date().toLocaleDateString('id-ID',{day:'2-digit',month:'long',year:'numeric'});const jam=new Date().toLocaleTimeString('id-ID',{hour12:false});let txt=['‚îÄ‚îÄ‚îÄ„Äå ACCOUNT DETAIL „Äç‚îÄ‚îÄ‚îÄ','Silakan simpan detail berikut.','','‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ„Äå TRANSAKSI DETAIL „Äç‚îÄ‚îÄ‚îÄ‚îÄ',`‚îä„Éª üßæ Reff ID: ${ref}`,`‚îä„Éª üì¶ Produk: ${prod.name}`,`‚îä„Éª üè∑Ô∏è Harga Dasar: ${toRp(base)}`,`‚îä„Éª üìà Biaya Admin (${fee}%): ${toRp(adm)}`,`‚îä„Éª üõçÔ∏è Jumlah: ${qty}`,`‚îä„Éª üí∞ Total Bayar: ${toRp(total)}`,`‚îä„Éª üìÖ Tanggal: ${tanggal}`,`‚îä„Éª ‚è∞ Jam: ${jam} WIB`,'‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ','','‚îÄ‚îÄ‚îÄ„Äå SNK PRODUK „Äç‚îÄ‚îÄ‚îÄ', (prod.snk||'-'),'', '‚îÄ‚îÄ‚îÄ„Äå DATA AKUN „Äç‚îÄ‚îÄ‚îÄ'].join('\n');txt+='\n'+items.map(x=>`‚Ä¢ Email: ${x.email}\n‚Ä¢ Password: ${x.pass}\n‚Ä¢ Profil: ${x.profil}\n‚Ä¢ Pin: ${x.pin}\n‚Ä¢ 2FA: ${x.fa}\n`).join('\n');const blob=new Blob([txt],{type:'text/plain'});const url=URL.createObjectURL(blob);deliverBody.innerHTML=`<div class="badge">Pembelian berhasil. Unduh file TXT:</div><div style="margin:10px 0"><a class="btn" href="${url}" download="TRX-${ref}.txt">Unduh TRX-${ref}.txt</a></div><pre style="white-space:pre-wrap" class="badge">${txt.replace(/</g,'&lt;')}</pre>`;deliverDialog.showModal();toast('Produk dikirim')}
function r(n){const a='ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';let o='';for(let i=0;i<n;i++)o+=a[Math.floor(Math.random()*a.length)];return o}
function toast(m){const t=document.getElementById('toast');const el=document.createElement('div');el.className='toast';el.textContent=m;t.appendChild(el);setTimeout(()=>{el.style.opacity='.0'},2200);setTimeout(()=>{t.removeChild(el)},2600)}
const themeBtn=document.getElementById('themeToggle');const root=document.documentElement;const saved=localStorage.getItem('theme');if(saved)root.setAttribute('data-theme',saved);themeBtn.onclick=()=>{const cur=root.getAttribute('data-theme')==='light'?'dark':'light';root.setAttribute('data-theme',cur);localStorage.setItem('theme',cur)}
