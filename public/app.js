// same as built earlier with cancel fix
const fmt=new Intl.NumberFormat('id-ID');const toRp=n=>`Rp${fmt.format(n)}`;const store={get(){try{return JSON.parse(localStorage.getItem('rx_products')||'null')}catch{return null}},set(d){localStorage.setItem('rx_products',JSON.stringify(d))}};const balanceStore={get(){return Number(localStorage.getItem('rx_balance')||'0')},add(n){localStorage.setItem('rx_balance',String(this.get()+n))},min(n){localStorage.setItem('rx_balance',String(Math.max(0,this.get()-n)))}};const defaults={categories:['Streaming','Game','Tools'],products:[{id:'netflix',name:'Netflix 1 Bulan',desc:'Akun Netflix premium',snk:'Garansi 7 hari',price:30000,profit:5000,terjual:0,category:'Streaming',stok:['acc1@mail.com|pass1|Standard|-|2FA1|32000','acc2@mail.com|pass2|Premium|-|2FA2|32000']}]};let data=store.get()||defaults;const feePct=Number(window.AppConfig?.pajak??3);document.getElementById('feePct').textContent=feePct+'%';document.getElementById('userBalance').textContent=toRp(balanceStore.get());const catSel=document.getElementById('category');const setCategories=()=>{catSel.innerHTML='<option value="">Semua Kategori</option>'+data.categories.map(c=>`<option>${c}</option>`).join('')};setCategories();const grid=document.getElementById('productGrid');const prodCount=()=>data.products.filter(p=>p.stok.length>0).length;const render=()=>{const term=(document.getElementById('search').value||'').toLowerCase();const cat=catSel.value;const list=data.products.filter(p=>(!term||p.name.toLowerCase().includes(term)||p.id.toLowerCase().includes(term))&&(!cat||p.category===cat));document.getElementById('prodCount').textContent=String(prodCount());grid.innerHTML=list.map(p=>`<div class="card"><h3>${p.name}</h3><div class="muted">${p.desc||'-'}</div><div class="row"><span class="pill">Kategori: ${p.category}</span><span class="pill">Stok: ${p.stok.length}</span><span class="pill">Terjual: ${p.terjual}</span></div><div class="price">${toRp(Number(p.price))}</div><div class="row"><input id="qty_${p.id}" type="number" min="1" value="1"/><button class="btn" ${p.stok.length===0?'disabled':''} onclick="startBuy('${p.id}')">Beli</button></div></div>`).join('')};render();document.getElementById('search').addEventListener('input',render);catSel.addEventListener('change',render);document.getElementById('reset').addEventListener('click',()=>{document.getElementById('search').value='';catSel.value='';render()});const buyDialog=document.getElementById('buyDialog');const deliverDialog=document.getElementById('deliverDialog');const checkoutBody=document.getElementById('checkoutBody');const deliverBody=document.getElementById('deliverBody');window.startBuy=id=>{const p=data.products.find(x=>x.id===id);if(!p)return alert('Produk tidak ditemukan');const qty=Number(document.getElementById('qty_'+id).value||'1');if(!qty||qty<=0)return alert('Jumlah tidak valid');if(p.stok.length<qty)return alert('Stok tidak cukup! Tersedia: '+p.stok.length);const sample=(p.stok[0]||'').split('|');const unit=(sample.length>=6&&!isNaN(Number(sample[5])))?Number(sample[5]):Number(p.price);const base=unit*qty;const admin=Math.ceil(base*(feePct/100));const total=base+admin;const balance=balanceStore.get();const need=balance<total?total-balance:0;checkoutBody.innerHTML=`<table style="width:100%"><tr><td>Produk</td><td style="text-align:right"><strong>${p.name}</strong></td></tr><tr><td>Jumlah</td><td style="text-align:right"><strong>${qty}</strong></td></tr><tr><td>Harga Dasar</td><td style="text-align:right">${toRp(base)}</td></tr><tr><td>Biaya Admin (${feePct}%)</td><td style="text-align:right">${toRp(admin)}</td></tr><tr><td><strong>Total</strong></td><td style="text-align:right"><strong>${toRp(total)}</strong></td></tr><tr><td>Saldo Anda</td><td style="text-align:right">${toRp(balance)}</td></tr>${need?`<tr><td>Kekurangan</td><td style="text-align:right"><span class="mono">${toRp(need)}</span></td></tr>`:''}</table><div class="row" style="justify-content:flex-end;margin-top:10px"><button class="btn-ghost btn" onclick="buyDialog.close()">Tutup</button><button id="btnPay" class="btn">${need?'Bayar Kekurangan':'Bayar & Proses'}</button></div><div id="payArea"></div>`;buyDialog.showModal();document.getElementById('btnPay').onclick=()=>handlePay(p,qty,base,admin,total,need)};async function handlePay(prod,qty,base,admin,total,shortage){const payArea=document.getElementById('payArea');if(shortage<=0){balanceStore.min(total);processOrder(prod,qty,base,admin,total);buyDialog.close();return}const {apikey,username,tokenorkut}=window.AppConfig.api;const createUrl=`https://apii.ryuuxiao.biz.id/orderkuota/createpayment?apikey=${encodeURIComponent(apikey)}&username=${encodeURIComponent(username)}&token=${encodeURIComponent(tokenorkut)}&amount=${encodeURIComponent(shortage)}`;payArea.innerHTML=`<div class="muted">Membuat QRIS...</div>`;try{const res=await fetch(createUrl);const json=await res.json();if(!json?.status)throw new Error('Gagal membuat QRIS');const qrUrl=json.result?.imageqris?.url;const deadline=Date.now()+Number((window.AppConfig.paymentWindowMinutes||30)*60*1000);payArea.innerHTML=`<div class="row" style="align-items:flex-start;gap:16px;margin-top:12px"><div class="qr"><img src="${qrUrl}" alt="QRIS" style="max-width:240px;width:100%;height:auto"/></div><div style="flex:1"><div><strong>Scan QRIS untuk membayar ${toRp(shortage)}</strong></div><div id="countdown" class="muted"></div><div style="margin-top:8px"><button id="btnCancel" class="btn btn-ghost">‚ùå Batalkan</button></div></div></div>`;const countdownEl=document.getElementById('countdown');const t=setInterval(()=>{const left=deadline-Date.now();if(left<=0){clearInterval(t);payArea.innerHTML='<div class="muted">Waktu pembayaran habis.</div>'}const m=Math.floor(left/60000),s=Math.floor((left%60000)/1000);if(left>0)countdownEl.textContent=`Bayar sebelum ${new Date(deadline).toLocaleTimeString('id-ID',{hour12:false})} WIB (${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')})`},1000);let stop=false;const poll=setInterval(async()=>{if(stop){clearInterval(poll);return}if(Date.now()>=deadline){clearInterval(poll);return}try{const r=await fetch(`https://apii.ryuuxiao.biz.id/orderkuota/mutasiqr?apikey=${encodeURIComponent(apikey)}&username=${encodeURIComponent(username)}&token=${encodeURIComponent(tokenorkut)}`);const j=await r.json();const list=j?.result||[];const found=list.find(x=>x.status==='IN'&&Number(String(x.kredit||'0').replace(/\./g,''))===shortage);if(found){clearInterval(poll);clearInterval(t);balanceStore.add(shortage);balanceStore.min(total);buyDialog.close();processOrder(prod,qty,base,admin,total)}}catch(e){}},10000);document.getElementById('btnCancel').onclick=()=>{stop=true;clearInterval(t);clearInterval(poll);payArea.innerHTML='<div class="muted">‚ùå Transaksi QRIS dibatalkan.</div>'}}catch(e){payArea.innerHTML=`<div class="muted">Error: ${e.message}</div>`}}function processOrder(prod,qty,base,adminFee,total){const items=[];for(let i=0;i<qty;i++){const line=prod.stok.shift();const [email,pass,profil='-',pin='-',fa='-']=(line||'').split('|');items.push({email,pass,profil,pin,fa})}prod.terjual+=qty;store.set(data);render();const ref=(()=>{const al='ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';let o='';for(let i=0;i<8;i++)o+=al[Math.floor(Math.random()*al.length)];return o})();const tanggal=new Date().toLocaleDateString('id-ID',{day:'2-digit',month:'long',year:'numeric'});const jam=new Date().toLocaleTimeString('id-ID',{hour12:false});const receipt=['‚îÄ‚îÄ‚îÄ„Äå ACCOUNT DETAIL „Äç‚îÄ‚îÄ‚îÄ','Silakan simpan detail berikut.','','‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ„Äå TRANSAKSI DETAIL „Äç‚îÄ‚îÄ‚îÄ‚îÄ',`‚îä„Éª üßæ Reff ID: ${ref}`,`‚îä„Éª üì¶ Produk: ${prod.name}`,`‚îä„Éª üè∑Ô∏è Harga Dasar: ${toRp(base)}`,`‚îä„Éª üìà Biaya Admin (${feePct}%): ${toRp(adminFee)}`,`‚îä„Éª üõçÔ∏è Jumlah: ${qty}`,`‚îä„Éª üí∞ Total Bayar: ${toRp(total)}`,`‚îä„Éª üìÖ Tanggal: ${tanggal}`,`‚îä„Éª ‚è∞ Jam: ${jam} WIB`,'‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ','','‚îÄ‚îÄ‚îÄ„Äå SNK PRODUK „Äç‚îÄ‚îÄ‚îÄ',(prod.snk||'-'),'','‚îÄ‚îÄ‚îÄ„Äå DATA AKUN „Äç‚îÄ‚îÄ‚îÄ'].join('\n');const akun=items.map(x=>`‚Ä¢ Email: ${x.email}\n‚Ä¢ Password: ${x.pass}\n‚Ä¢ Profil: ${x.profil}\n‚Ä¢ Pin: ${x.pin}\n‚Ä¢ 2FA: ${x.fa}\n`).join('\n');const txt=receipt+'\n'+akun;const blob=new Blob([txt],{type:'text/plain'});const url=URL.createObjectURL(blob);deliverBody.innerHTML=`<div class="muted">Pembelian berhasil. Unduh file TXT di bawah:</div><div style="margin:12px 0"><a class="btn" href="${url}" download="TRX-${ref}.txt">Unduh TRX-${ref}.txt</a></div><pre class="mono" style="white-space:pre-wrap;background:#0f1a3b;border:1px solid #243059;padding:12px;border-radius:12px;max-height:260px;overflow:auto">${txt.replace(/</g,'&lt;')}</pre>`;deliverDialog.showModal()}
